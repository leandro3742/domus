#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-push checks..."

# Run TypeScript type checking (faster than full build)
echo "ğŸ“ Checking TypeScript types..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type checking failed. Please fix type errors before pushing."
    exit 1
fi

# Store current git state to detect changes
echo "ğŸ”§ Running ESLint with auto-fix..."
BEFORE_FIX=$(git status --porcelain)
npm run lint:fix
AFTER_FIX=$(git status --porcelain)

# Check if any files were modified by the fix
if [ "$BEFORE_FIX" != "$AFTER_FIX" ]; then
    echo "ğŸ“ ESLint fixed some issues. Adding fixed files to commit..."
    # Only add files that were actually modified by ESLint
    git add -u
    echo "âš ï¸  Fixed files were added. Please run git push again."
    exit 1
fi

# Final ESLint check to ensure no remaining errors
echo "âœ… Running final ESLint check..."
npm run lint
if [ $? -ne 0 ]; then
    echo "âŒ ESLint found errors that couldn't be auto-fixed. Please fix them manually."
    exit 1
fi

echo "âœ… All checks passed. Ready to push!"
